# System Architecture Documentation
*Generated: 2025-10-05 11:01:35*

## Overview

This document describes the architecture of the MINIMINIMOON system, including 66 dependency flows, 5 critical paths, and detailed component interactions.

## System Components

### Core Components

- **causal_pattern_detector**
  - Incoming dependencies: 4
  - Outgoing dependencies: 0
  - Type: Critical

- **cli**
  - Incoming dependencies: 0
  - Outgoing dependencies: 4
  - Type: Critical

- **contradiction_detector**
  - Incoming dependencies: 2
  - Outgoing dependencies: 0
  - Type: Critical

- **dag_validation**
  - Incoming dependencies: 4
  - Outgoing dependencies: 2
  - Type: Critical

- **data_flow_contract**
  - Incoming dependencies: 3
  - Outgoing dependencies: 0
  - Type: Critical

- **decalogo_pipeline_orchestrator**
  - Incoming dependencies: 0
  - Outgoing dependencies: 7
  - Type: Critical

- **document_segmenter**
  - Incoming dependencies: 2
  - Outgoing dependencies: 0
  - Type: Critical

- **embedding_model**
  - Incoming dependencies: 4
  - Outgoing dependencies: 0
  - Type: Critical

- **evidence_registry**
  - Incoming dependencies: 3
  - Outgoing dependencies: 0
  - Type: Critical

- **example_usage**
  - Incoming dependencies: 0
  - Outgoing dependencies: 1
  - Type: Critical

- **feasibility_scorer**
  - Incoming dependencies: 6
  - Outgoing dependencies: 0
  - Type: Critical

- **integrated_evaluation_system**
  - Incoming dependencies: 0
  - Outgoing dependencies: 2
  - Type: Critical

- **integration_example**
  - Incoming dependencies: 0
  - Outgoing dependencies: 1
  - Type: Critical

- **json_utils**
  - Incoming dependencies: 1
  - Outgoing dependencies: 0
  - Type: Critical

- **log_config**
  - Incoming dependencies: 5
  - Outgoing dependencies: 0
  - Type: Critical

- **miniminimoon_immutability**
  - Incoming dependencies: 1
  - Outgoing dependencies: 0
  - Type: Critical

- **miniminimoon_orchestrator**
  - Incoming dependencies: 2
  - Outgoing dependencies: 16
  - Type: Critical

- **monetary_detector**
  - Incoming dependencies: 4
  - Outgoing dependencies: 0
  - Type: Critical

- **plan_processor**
  - Incoming dependencies: 2
  - Outgoing dependencies: 1
  - Type: Critical

- **plan_sanitizer**
  - Incoming dependencies: 2
  - Outgoing dependencies: 1
  - Type: Critical

- **questionnaire_engine**
  - Incoming dependencies: 4
  - Outgoing dependencies: 0
  - Type: Critical

- **responsibility_detector**
  - Incoming dependencies: 3
  - Outgoing dependencies: 0
  - Type: Critical

- **spacy_loader**
  - Incoming dependencies: 1
  - Outgoing dependencies: 0
  - Type: Critical

- **system_validators**
  - Incoming dependencies: 1
  - Outgoing dependencies: 0
  - Type: Critical

- **teoria_cambio**
  - Incoming dependencies: 4
  - Outgoing dependencies: 1
  - Type: Critical

- **unified_evaluation_pipeline**
  - Incoming dependencies: 0
  - Outgoing dependencies: 4
  - Type: Critical

- **verify_coverage_metric**
  - Incoming dependencies: 0
  - Outgoing dependencies: 10
  - Type: Critical

- **verify_reproducibility**
  - Incoming dependencies: 0
  - Outgoing dependencies: 1
  - Type: Critical


## Dependency Statistics

- Total dependency flows: 66
- Critical flows: 39
- Unique modules: 45
- Critical paths identified: 5
- Canonical flow order: defined in `tools/flow_doc.json`

## Flow Types Distribution

- Configuration: 5 flows
- Control: 2 flows
- Data: 58 flows
- Utility: 1 flows

---

## Artifacts Directory

The `artifacts/` directory serves as the **canonical location for all pipeline outputs** that provide evidence for system correctness, reproducibility, and auditability. All validation tools, CI/CD gates, and auditing processes consume these artifacts to verify system behavior.

### Directory Purpose

- **Canonical Output Location**: Single source of truth for pipeline execution results
- **Evidence for Correctness**: Cryptographically verifiable proof of deterministic execution
- **Reproducibility Guarantee**: Complete execution trace enabling bit-for-bit reproduction
- **Audit Trail**: Immutable record of all decisions, evidence, and evaluations
- **Validation Input**: Primary data source for pre/post execution gates and compliance checks

### Artifact Specifications

#### 1. flow_runtime.json

**Purpose**: Execution trace capturing the exact order and timing of all pipeline stages.

**Generated By**: `run_evaluation.py`, `unified_evaluation_pipeline.py`

**Consumed By**: 
- `system_validators.py` (post-execution validation)
- `deterministic_pipeline_validator.py` (canonical flow validation)
- CI/CD audit gates

**Contents**:
```json
{
  "flow_hash": "sha256(canonical_order)",
  "stages": ["stage_1", "stage_2", ...],
  "order": ["stage_1", "stage_2", ...],
  "stage_count": 15,
  "stage_timestamps": {"stage_name": unix_timestamp},
  "errors": {},
  "duration_seconds": 45.2
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - `flow_hash` must be SHA-256 hex digest (64 chars)
  - `stages` and `order` must contain identical elements
  - `stage_count` must equal length of `stages`
  - `stage_timestamps` keys must match `stages` exactly
  - `duration_seconds` must be non-negative float
- **Completeness Checks**:
  - All 15 canonical stages must be present
  - No duplicate stages in order
  - Timestamps must be monotonically increasing
- **Relationships**:
  - `order` must exactly match `tools/flow_doc.json` canonical_order
  - `flow_hash` must match hash computed from `order`
  - Referenced in `results_bundle.json` and `final_results.json`

#### 2. evidence_registry.json

**Purpose**: Cryptographically-hashed registry of all evidence extracted during pipeline execution.

**Generated By**: `run_evaluation.py`, `evidence_registry.py`, `unified_evaluation_pipeline.py`

**Consumed By**:
- `run_evaluation.py` (hash verification)
- `system_validators.py` (evidence presence validation)
- All evaluation modules (evidence consumption)
- Audit and compliance tools

**Contents**:
```json
{
  "evidence_count": 25,
  "deterministic_hash": "sha256(sorted_evidence)",
  "evidence": {
    "ev_001": {
      "evidence_id": "detector::type::hash",
      "stage": "responsibility_detection",
      "content": {...},
      "confidence": 0.85,
      "source_segment_ids": ["seg_1"],
      "timestamp": "ISO-8601"
    }
  }
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - `evidence_count` must equal number of keys in `evidence`
  - `deterministic_hash` must be SHA-256 hex digest
  - Each evidence_id must follow format `{detector}::{type}::{hash}`
  - `confidence` must be in range [0.0, 1.0]
  - `timestamp` must be valid ISO-8601
- **Completeness Checks**:
  - All evidence_ids must be globally unique
  - All referenced `source_segment_ids` must exist
  - All evidence must have non-empty content
- **Relationships**:
  - Referenced by `answers_report.json` evidence_ids
  - Hash included in `final_results.json` for non-repudiation
  - Consumed by `module_to_questions_matrix.csv` for traceability

#### 3. answers_report.json

**Purpose**: Complete report of all 300 questionnaire answers with evidence linkage and confidence scores.

**Generated By**: `run_evaluation.py`, `unified_evaluation_pipeline.py`, `questionnaire_engine.py`

**Consumed By**:
- `system_validators.py` (coverage validation ≥300 questions)
- `trace_matrix.py` (provenance traceability)
- `verify_coverage_metric.py` (rubric validation)
- Scoring and reporting tools

**Contents**:
```json
{
  "summary": {
    "total_questions": 300,
    "answered_questions": 300,
    "avg_confidence": 0.78,
    "avg_score": 0.72
  },
  "answers": [
    {
      "question_id": "DE-1-Q1",
      "dimension": "DE-1",
      "evidence_ids": ["ev_001", "ev_002"],
      "confidence": 0.85,
      "score": 0.72,
      "reasoning": "Evidence-based rationale",
      "rubric_weight": 0.00333,
      "supporting_quotes": ["Quote 1"]
    }
  ]
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - `total_questions` must equal length of `answers` array
  - `total_questions` must be ≥300 (coverage threshold)
  - Each `question_id` must be unique
  - `confidence` and `score` must be in [0.0, 1.0]
  - `rubric_weight` sum across all answers must equal 1.0
- **Completeness Checks**:
  - All questions from `RUBRIC_SCORING.json` must be present
  - All `evidence_ids` must exist in `evidence_registry.json`
  - No missing required fields in any answer
- **Relationships**:
  - `question_id` must match keys in `RUBRIC_SCORING.json`
  - `evidence_ids` must reference valid entries in `evidence_registry.json`
  - Consumed by `module_to_questions_matrix.csv` for traceability
  - Summary included in `results_bundle.json`

#### 4. answers_sample.json

**Purpose**: Human-readable sample of first 10 answers for quick validation and debugging.

**Generated By**: `run_evaluation.py`

**Consumed By**:
- Manual inspection and debugging
- Quick validation in CI/CD pipelines
- Documentation and examples

**Contents**:
```json
{
  "answers": [
    // First 10 answers from answers_report.json
  ]
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - Must contain exactly 10 answers (or fewer if total < 10)
  - Each answer must match schema from `answers_report.json`
- **Completeness Checks**:
  - Must be exact subset of `answers_report.json`
  - Order must match first N entries from full report
- **Relationships**:
  - Must be synchronized with `answers_report.json`
  - Used for smoke testing before full validation

#### 5. module_to_questions_matrix.csv

**Purpose**: Provenance traceability matrix mapping each question to source detection modules via evidence IDs.

**Generated By**: `trace_matrix.py`

**Consumed By**:
- Audit and compliance verification
- Coverage analysis tools
- Provenance debugging
- External auditors

**Contents**:
```csv
module,question_id,evidence_id,confidence,score
responsibility_detector,DE-1-Q1,responsibility_detector::assignment::a3f9,0.85,0.72
monetary_detector,DE-1-Q2,monetary_detector::amount::f2c1,0.90,0.78
```

**Validation Requirements**:
- **Schema Constraints**:
  - Must be valid UTF-8 CSV with header row
  - Header: `module,question_id,evidence_id,confidence,score`
  - `confidence` and `score` must be parseable as floats
  - No empty cells allowed
- **Completeness Checks**:
  - All `question_id` from `answers_report.json` must be present
  - All `evidence_id` must exist in `evidence_registry.json`
  - Module names must match first segment of evidence_id
- **Relationships**:
  - Direct expansion of `answers_report.json` evidence linkage
  - Enables reverse lookup from question → evidence → detector
  - Used for coverage analysis across detection modules

#### 6. coverage_report.json

**Purpose**: Test coverage analysis report showing which questions and modules are exercised.

**Generated By**: `test_coverage_analyzer.py`, `verify_coverage_metric.py`

**Consumed By**:
- CI/CD quality gates
- Coverage monitoring dashboards
- Regression testing

**Contents**:
```json
{
  "coverage_summary": {
    "total_questions": 300,
    "covered_questions": 300,
    "coverage_percentage": 100.0
  },
  "module_coverage": {
    "responsibility_detector": {"questions": 75, "percentage": 25.0},
    "monetary_detector": {"questions": 50, "percentage": 16.7}
  },
  "uncovered_questions": []
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - `coverage_percentage` must be in [0.0, 100.0]
  - `covered_questions` ≤ `total_questions`
  - Sum of module_coverage questions must equal covered_questions
- **Completeness Checks**:
  - All modules from `module_to_questions_matrix.csv` must appear
  - `uncovered_questions` must be empty for production runs
- **Relationships**:
  - Derived from `answers_report.json` and `module_to_questions_matrix.csv`
  - Must show 100% coverage for CI/CD gate to pass

#### 7. results_bundle.json

**Purpose**: Comprehensive bundle of pre-validation, execution results, and post-validation for complete audit trail.

**Generated By**: `run_evaluation.py`

**Consumed By**:
- CI/CD audit gates
- Compliance reporting
- End-to-end validation tools

**Contents**:
```json
{
  "pre_validation": {
    "pre_validation_ok": true,
    "checks": [...]
  },
  "pipeline_results": {
    "plan_path": "data/plan.txt",
    "orchestrator_version": "2.0.0",
    "start_time": "ISO-8601",
    "stages_completed": [...],
    "evaluations": {...},
    "evidence_hash": "sha256",
    "validation": {"flow_valid": true, "flow_hash": "sha256"}
  },
  "post_validation": {
    "post_validation_ok": true,
    "checks": [...]
  },
  "bundle_timestamp": "ISO-8601"
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - `pre_validation_ok` and `post_validation_ok` must be boolean
  - All hashes must be SHA-256 format
  - Timestamps must be ISO-8601
- **Completeness Checks**:
  - All validation checks must have status PASS/FAIL
  - `stages_completed` must match `flow_runtime.json`
  - Evidence hash must match `evidence_registry.json`
- **Relationships**:
  - Aggregates data from all other artifacts
  - Primary input for compliance verification
  - Must be immutable once generated

#### 8. final_results.json

**Purpose**: Final aggregated results with deterministic hash for non-repudiation.

**Generated By**: `run_evaluation.py`

**Consumed By**:
- Non-repudiation verification
- Result comparison across runs
- Final reporting and dashboards

**Contents**:
```json
{
  "result_hash": "sha256(evidence_hash + flow_hash + total_questions)",
  "evidence_hash": "sha256",
  "flow_hash": "sha256",
  "summary": {
    "total_questions": 300,
    "overall_score": 0.73,
    "execution_time": 45.2,
    "all_gates_passed": true
  }
}
```

**Validation Requirements**:
- **Schema Constraints**:
  - All hashes must be SHA-256 hex format (64 chars)
  - `overall_score` must be in [0.0, 1.0]
  - `execution_time` must be positive float
  - `all_gates_passed` must be boolean
- **Completeness Checks**:
  - `result_hash` must be verifiable from constituent hashes
  - `evidence_hash` must match `evidence_registry.json`
  - `flow_hash` must match `flow_runtime.json`
- **Relationships**:
  - Top-level summary referencing all other artifacts
  - Used for reproducibility verification across executions
  - Enables cryptographic proof of result integrity

#### 9. nonrepudiation_bundle.zip

**Purpose**: Compressed archive of all artifacts for archival and external audit.

**Generated By**: Archive scripts (external to main pipeline)

**Consumed By**:
- External auditors
- Long-term archival systems
- Compliance verification

**Contents**:
- All JSON artifacts listed above
- `module_to_questions_matrix.csv`
- Manifest file with checksums
- Timestamp and signature metadata

**Validation Requirements**:
- **Schema Constraints**:
  - Must be valid ZIP archive
  - Must include manifest with SHA-256 checksums
  - Must include timestamp of bundle creation
- **Completeness Checks**:
  - All 8 artifacts must be present in archive
  - Checksums in manifest must match actual file hashes
  - No extraneous files allowed
- **Relationships**:
  - Self-contained snapshot of complete execution
  - Can be extracted and validated independently
  - Used for forensic analysis and compliance audits

#### 10. run*.json (Timestamped Execution Records)

**Purpose**: Timestamped copies of execution results for historical comparison.

**Generated By**: `unified_evaluation_pipeline.py` (_export_results)

**Consumed By**:
- Historical analysis tools
- Regression testing
- Performance trend analysis

**Contents**:
```json
{
  "status": "success",
  "metadata": {
    "pdm_path": "path/to/plan.txt",
    "execution_start": "ISO-8601",
    "execution_end": "ISO-8601",
    "execution_time_seconds": 45.2
  },
  "pipeline": {...},
  "evidence_registry": {...},
  "evaluations": {...},
  "validation": {...}
}
```

**Naming Convention**: `{plan_name}_results_{timestamp}.json`

**Validation Requirements**:
- **Schema Constraints**:
  - Must follow unified_evaluation_pipeline result schema
  - Timestamps must be ISO-8601 format
  - Status must be one of: success, failure, partial
- **Completeness Checks**:
  - Must include all pipeline, evidence, and validation sections
  - Metadata must have all required fields
- **Relationships**:
  - Companion files: `{plan_name}_evidence_{timestamp}.json`
  - Enables comparison across multiple runs of same plan
  - Used for detecting regressions and performance changes

### Validation Tool Integration

| Artifact | Generator | Primary Validator | Secondary Validators |
|----------|-----------|-------------------|---------------------|
| flow_runtime.json | run_evaluation.py | system_validators.py | deterministic_pipeline_validator.py |
| evidence_registry.json | evidence_registry.py | system_validators.py | All evaluation modules |
| answers_report.json | questionnaire_engine.py | system_validators.py | trace_matrix.py, verify_coverage_metric.py |
| answers_sample.json | run_evaluation.py | Manual inspection | CI smoke tests |
| module_to_questions_matrix.csv | trace_matrix.py | Audit tools | Coverage analyzers |
| coverage_report.json | test_coverage_analyzer.py | CI/CD gates | Quality dashboards |
| results_bundle.json | run_evaluation.py | Compliance tools | Audit systems |
| final_results.json | run_evaluation.py | Non-repudiation tools | Comparison utilities |
| nonrepudiation_bundle.zip | Archive scripts | Audit systems | Forensic tools |
| run*.json | unified_evaluation_pipeline.py | Regression tools | Trend analyzers |

### Artifact Dependencies

```
flow_runtime.json
  ↓
evidence_registry.json
  ↓
answers_report.json
  ├→ answers_sample.json
  └→ module_to_questions_matrix.csv
       ↓
     coverage_report.json
       ↓
     results_bundle.json ← flow_runtime.json
       ↓                 ← evidence_registry.json
     final_results.json
       ↓
     nonrepudiation_bundle.zip (all artifacts)
```

### Usage in CI/CD Pipeline

```bash
# Generate artifacts
python run_evaluation.py

# Validate artifacts
python system_validators.py --post --artifacts artifacts/

# Generate traceability
python trace_matrix.py

# Verify coverage
python verify_coverage_metric.py

# All artifacts now in artifacts/ for archival
```

### Artifact Immutability Contract

Once generated, artifacts in `artifacts/` are **immutable**:
- No modification after creation
- Cryptographic hashes verify integrity
- Any change invalidates dependent artifacts
- Reproducibility requires identical inputs → identical artifacts

---

See also:
- [Dependency Flows](DEPENDENCY_FLOWS.md)
- [Critical Paths](CRITICAL_PATHS.md)
- [Data Contracts](DATA_CONTRACTS.md)
- [Component Diagram](COMPONENT_DIAGRAM.md)
- Canonical flow order: `tools/flow_doc.json`
