name: Mutation Testing

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mutmut pytest
        python -m spacy download es_core_news_sm
    
    - name: Run mutation tests on critical paths
      run: |
        mutmut run \
          --paths-to-mutate=embedding_model.py,responsibility_detector.py,teoria_cambio.py,dag_validation.py,feasibility_scorer.py,contradiction_detector.py \
          --tests-dir=. \
          --runner="pytest -x" \
          --use-coverage || true
    
    - name: Generate mutation report
      run: |
        mutmut results
        mutmut html
    
    - name: Check mutation score
      run: |
        MUTATION_SCORE=$(mutmut result-ids killed | wc -l)
        TOTAL_MUTATIONS=$(mutmut result-ids all | wc -l)
        SCORE=$((100 * MUTATION_SCORE / TOTAL_MUTATIONS))
        echo "Mutation score: $SCORE%"
        if [ $SCORE -lt 80 ]; then
          echo "::warning::Mutation score $SCORE% below target of 80%"
        fi
    
    - name: Upload mutation report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: mutation-report
        path: html/
