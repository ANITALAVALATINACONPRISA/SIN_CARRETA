digraph FifteenStagePipeline {
    graph [bgcolor="#0a0e27", fontname="JetBrains Mono", fontsize=12, rankdir=TB, splines=polyline, pad=0.5, nodesep=0.5, ranksep=0.8];
    node [fontname="JetBrains Mono", fontsize=9, style="filled,rounded", shape=box, margin=0.25];
    edge [fontname="JetBrains Mono", fontsize=8, arrowsize=0.7];

    // Title
    label=<
        <table border="0" cellborder="0" cellspacing="0">
            <tr><td><font point-size="24" color="#00d4ff"><b>‚öôÔ∏è 15-STAGE CANONICAL PIPELINE</b></font></td></tr>
            <tr><td><font point-size="12" color="#00ff88">Sequential Processing: Sanitization ‚Üí Evidence Registry ‚Üí Evaluation ‚Üí Assembly</font></td></tr>
        </table>
    >;
    labelloc="t";

    // Input
    input [label="üìÑ Raw PDM\nPlan", shape=ellipse, fillcolor="#ff00ff", color="#ff00ff", fontcolor="#000000", penwidth=2, style="filled"];

    // Phase 1: Processing (Stages 1-11)
    subgraph cluster_phase1 {
        label=<
            <font color="#00ffff"><b>üîß PHASE 1: PROCESSING (Stages 1-11)</b></font>
        >;
        style=filled;
        fillcolor="#1a1f35";
        color="#00ffff";
        penwidth=2;

        s1 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a1f3a">
                <tr><td><font color="#00ffff"><b>Stage 1</b></font></td></tr>
                <tr><td><font color="#ffffff">Sanitization</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí sanitized_text</font></td></tr>
            </table>
        >, fillcolor="#2a1f3a", color="#ff00ff", shape=box];

        s2 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a1f3a">
                <tr><td><font color="#00ffff"><b>Stage 2</b></font></td></tr>
                <tr><td><font color="#ffffff">Plan Processing</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí doc_struct</font></td></tr>
            </table>
        >, fillcolor="#2a1f3a", color="#ff00ff", shape=box];

        s3 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a1f3a">
                <tr><td><font color="#00ffff"><b>Stage 3</b></font></td></tr>
                <tr><td><font color="#ffffff">Segmentation</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí segments</font></td></tr>
            </table>
        >, fillcolor="#2a1f3a", color="#ff00ff", shape=box];

        s4 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a1f3a">
                <tr><td><font color="#00ffff"><b>Stage 4</b></font></td></tr>
                <tr><td><font color="#ffffff">Embeddings</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí embeddings</font></td></tr>
            </table>
        >, fillcolor="#2a1f3a", color="#ff00ff", shape=box];

        s5 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 5</b></font></td></tr>
                <tr><td><font color="#ffffff">Responsibility</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí responsibilities</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s6 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 6</b></font></td></tr>
                <tr><td><font color="#ffffff">Contradiction</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí contradictions</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s7 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 7</b></font></td></tr>
                <tr><td><font color="#ffffff">Monetary</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí monetary</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s8 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 8</b></font></td></tr>
                <tr><td><font color="#ffffff">Feasibility</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí feasibility</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s9 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 9</b></font></td></tr>
                <tr><td><font color="#ffffff">Causal Pattern</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí causal_patterns</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s10 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 10</b></font></td></tr>
                <tr><td><font color="#ffffff">Teor√≠a Cambio</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí toc_graph</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];

        s11 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2f3a">
                <tr><td><font color="#00ffff"><b>Stage 11</b></font></td></tr>
                <tr><td><font color="#ffffff">DAG Validation</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí dag_diagnostics</font></td></tr>
            </table>
        >, fillcolor="#2a2f3a", color="#00ff88", shape=box];
    }

    // Phase 2: Evidence Registry (Stage 12)
    s12 [label=<
        <table border="0" cellborder="1" cellspacing="0" cellpadding="10" bgcolor="#1a3050" color="#00ffff">
            <tr><td bgcolor="#00ffff"><font color="#000000"><b>üî∑ STAGE 12: EVIDENCE REGISTRY</b></font></td></tr>
            <tr><td align="left"><font color="#ffffff"><b>FAN-IN N:1</b></font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Merge all evidence</font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Deterministic hash</font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Provenance tracking</font></td></tr>
            <tr><td align="left"><font color="#00ff88"><b>‚Üí evidence_store</b></font></td></tr>
        </table>
    >, fillcolor="#1a3050", color="#00ffff", penwidth=3];

    // Phase 3: Evaluation (Stages 13-14)
    subgraph cluster_phase3 {
        label=<
            <font color="#ffff00"><b>üéì PHASE 3: EVALUATION (Stages 13-14)</b></font>
        >;
        style=filled;
        fillcolor="#1f1f2a";
        color="#ffff00";
        penwidth=2;

        s13 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2440">
                <tr><td><font color="#00ffff"><b>Stage 13</b></font></td></tr>
                <tr><td><font color="#ffffff">Dec√°logo Eval</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí decalogo_eval</font></td></tr>
            </table>
        >, fillcolor="#2a2440", color="#ffff00", shape=box];

        s14 [label=<
            <table border="0" cellborder="0" cellspacing="0" cellpadding="4" bgcolor="#2a2440">
                <tr><td><font color="#00ffff"><b>Stage 14</b></font></td></tr>
                <tr><td><font color="#ffffff">Questionnaire</font></td></tr>
                <tr><td><font color="#ffff00">‚Üí questionnaire_eval</font></td></tr>
            </table>
        >, fillcolor="#2a2440", color="#ffff00", shape=box];
    }

    // Phase 4: Assembly (Stage 15)
    s15 [label=<
        <table border="0" cellborder="1" cellspacing="0" cellpadding="10" bgcolor="#1a2050" color="#00ff88">
            <tr><td bgcolor="#00ff88"><font color="#000000"><b>üî∑ STAGE 15: ANSWER ASSEMBLY</b></font></td></tr>
            <tr><td align="left"><font color="#ffffff"><b>Final Merge</b></font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Combine evaluations</font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Add evidence_ids</font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Calculate scores</font></td></tr>
            <tr><td align="left"><font color="#ffff00">‚ñ∏ Generate reasoning</font></td></tr>
            <tr><td align="left"><font color="#00ff88"><b>‚Üí answers_report</b></font></td></tr>
        </table>
    >, fillcolor="#1a2050", color="#00ff88", penwidth=3];

    // Output
    output [label="üìÑ 300 Answers\nReport", shape=ellipse, fillcolor="#ffff00", color="#ffff00", fontcolor="#000000", penwidth=3, style="filled"];

    // Flow - Phase 1
    input -> s1 [label="1:1", color="#ff00ff", fontcolor="#ff00ff", penwidth=2];
    s1 -> s2 [label="1:1", color="#ff00ff", fontcolor="#ff00ff", penwidth=2];
    s2 -> s3 [label="1:N", color="#ff00ff", fontcolor="#ff00ff", penwidth=2];
    s3 -> s4 [label="1:N", color="#ff00ff", fontcolor="#ff00ff", penwidth=2];
    
    // Detector fan-out
    s4 -> s5 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s4 -> s6 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s4 -> s7 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s4 -> s8 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s4 -> s9 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s4 -> s10 [label="1:N", color="#00ff88", fontcolor="#00ff88", penwidth=1.5];
    s10 -> s11 [label="1:1", color="#00ff88", fontcolor="#00ff88", penwidth=2];

    // Evidence registry fan-in
    s5 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s6 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s7 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s8 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s9 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s10 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];
    s11 -> s12 [label="N:1", color="#00ffff", fontcolor="#00ffff", penwidth=2];

    // Evaluation
    s12 -> s13 [label="1:1", color="#ffff00", fontcolor="#ffff00", penwidth=2];
    s12 -> s14 [label="1:1", color="#ffff00", fontcolor="#ffff00", penwidth=2];

    // Assembly
    s13 -> s15 [label="1:1", color="#00ff88", fontcolor="#00ff88", penwidth=2];
    s14 -> s15 [label="1:1", color="#00ff88", fontcolor="#00ff88", penwidth=2];
    s12 -> s15 [label="1:1\nevidence", color="#00ff88", fontcolor="#00ff88", penwidth=3, style="bold"];

    s15 -> output [label="1:1", color="#ffff00", fontcolor="#ffff00", penwidth=3, style="bold"];
}
